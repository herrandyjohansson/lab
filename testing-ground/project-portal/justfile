# Development Frontend Deployment
# Deploy the frontend to Azure Static Web Apps

# Configuration variables
RESOURCE_GROUP := "rg-axis365-offering-portalapi-prod"
APP_NAME := "offering-portal-frontend-dev"
LOCATION := "westeurope"  # Static Web Apps supports: westus2, centralus, eastus2, westeurope, eastasia

# Default recipe - show available commands
default:
    @just --list

# Deploy latest changes to Azure Static Web Apps
# Usage: just deploy
deploy:
    #!/usr/bin/env bash
    set -e
    
    echo '=== Deploying Latest Changes ==='
    echo ""
    
    # Check if Azure CLI is installed
    if ! command -v az &> /dev/null; then
        echo 'Error: Azure CLI is not installed. Please install it first'
        exit 1
    fi
    
    # Check if Static Web Apps extension is installed
    if ! az extension list --query '[?name=='\''staticwebapp'\''].name' -o tsv | grep -q "staticwebapp"; then
        echo "Installing Azure Static Web Apps extension"
        az extension add --name staticwebapp
    fi
    
    # Check if logged in to Azure
    if ! az account show &> /dev/null; then
        echo 'Not logged in to Azure. Please log in'
        az login
    fi
    
    # Build the project
    echo "Building the project"
    if [ ! -d "node_modules" ]; then
        echo "Installing dependencies"
        npm install
    fi
    
    npm run build
    
    if [ ! -d "dist" ]; then
        echo 'Error: Build failed. dist directory not found.'
        exit 1
    fi
    
    echo "Build completed successfully"
    echo ""
    
    # Check if SWA CLI is installed
    if ! command -v swa &> /dev/null; then
        echo "Installing Azure Static Web Apps CLI"
        npm install -g @azure/static-web-apps-cli
    fi
    
    # Get deployment token
    echo "Getting deployment token"
    DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
        --name {{APP_NAME}} \
        --resource-group {{RESOURCE_GROUP}} \
        --query 'properties.apiKey' -o tsv)
    
    if [ -z "$DEPLOYMENT_TOKEN" ]; then
        echo "Error: Could not retrieve deployment token"
        exit 1
    fi
    
    # Deploy using SWA CLI
    echo "Deploying to Azure Static Web Apps"
    swa deploy ./dist \
        --deployment-token "$DEPLOYMENT_TOKEN" \
        --env production
    
    echo ""
    echo '=== Deployment Complete! ==='
    echo ""
    
    # Get the app URL
    APP_URL=$(az staticwebapp show \
        --name {{APP_NAME}} \
        --resource-group {{RESOURCE_GROUP}} \
        --query "defaultHostname" -o tsv)
    
    echo "Your application is available at"
    echo "https://${APP_URL}"
    echo ""
    echo 'Note: It may take a few minutes for the deployment to be fully available'

# Deploy frontend to Azure Static Web Apps (create app if needed, then build and deploy)
# Usage: just deploy-dev
deploy-dev:
    #!/usr/bin/env bash
    set -e
    
    # Check if Azure CLI is installed
    if ! command -v az &> /dev/null; then
        echo 'Error: Azure CLI is not installed. Please install it first'
        exit 1
    fi
    
    # Check if Static Web Apps extension is installed
    if ! az extension list --query '[?name=='\''staticwebapp'\''].name' -o tsv | grep -q "staticwebapp"; then
        echo "Installing Azure Static Web Apps extension"
        az extension add --name staticwebapp
    fi
    
    # Check if logged in to Azure
    echo "Checking Azure login status"
    if ! az account show &> /dev/null; then
        echo 'Not logged in to Azure. Please log in'
        az login
    fi
    
    # Get current subscription
    SUBSCRIPTION=$(az account show --query name -o tsv)
    echo "Using subscription: ${SUBSCRIPTION}"
    echo ""
    
    # Check if Static Web App exists
    echo "Checking if Static Web App exists"
    if az staticwebapp show --name {{APP_NAME}} --resource-group {{RESOURCE_GROUP}} &> /dev/null; then
        echo "Static Web App '{{APP_NAME}}' already exists"
        SKIP_CREATE=true
    else
        echo 'Static Web App {{APP_NAME}} does not exist. Creating'
        SKIP_CREATE=false
    fi
    
    # Create Static Web App if it doesn't exist
    if [ "$SKIP_CREATE" = false ]; then
        echo "Creating Static Web App"
        az staticwebapp create \
            --name {{APP_NAME}} \
            --resource-group {{RESOURCE_GROUP}} \
            --location {{LOCATION}} \
            --sku Free
        
        echo "Static Web App created successfully"
        echo ""
    fi
    
    # Configure build settings
    echo "Configuring build settings"
    az staticwebapp appsettings set \
        --name {{APP_NAME}} \
        --resource-group {{RESOURCE_GROUP}} \
        --setting-names \
            "BUILD_COMMAND=npm run build" \
            "APP_LOCATION=/" \
            "OUTPUT_LOCATION=dist" \
        &> /dev/null || true
    
    echo "Build settings configured"
    echo ""
    
    # Build the project
    echo "Building the project"
    if [ ! -d "node_modules" ]; then
        echo "Installing dependencies"
        npm install
    fi
    
    npm run build
    
    if [ ! -d "dist" ]; then
        echo 'Error: Build failed. dist directory not found.'
        exit 1
    fi
    
    echo "Build completed successfully"
    echo ""
    
    # Check if SWA CLI is installed
    if ! command -v swa &> /dev/null; then
        echo "Installing Azure Static Web Apps CLI"
        npm install -g @azure/static-web-apps-cli
    fi
    
    # Get deployment token
    echo "Getting deployment token"
    DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
        --name {{APP_NAME}} \
        --resource-group {{RESOURCE_GROUP}} \
        --query 'properties.apiKey' -o tsv)
    
    if [ -z "$DEPLOYMENT_TOKEN" ]; then
        echo "Error: Could not retrieve deployment token"
        exit 1
    fi
    
    # Deploy using SWA CLI
    echo "Deploying to Azure Static Web Apps"
    swa deploy ./dist \
        --deployment-token "$DEPLOYMENT_TOKEN" \
        --env production
    
    echo ""
    echo '=== Deployment Complete! ==='
    echo ""
    
    # Get the app URL
    APP_URL=$(az staticwebapp show \
        --name {{APP_NAME}} \
        --resource-group {{RESOURCE_GROUP}} \
        --query "defaultHostname" -o tsv)
    
    echo "Your application is available at"
    echo "https://${APP_URL}"
    echo ""
    echo 'Note: It may take a few minutes for the deployment to be fully available'
    echo 'You can check deployment status in Azure Portal'

# Get the URL of the deployed frontend
# Usage: just get-url
get-url:
    #!/usr/bin/env bash
    # Check if Azure CLI is installed
    if ! command -v az &> /dev/null; then
        echo 'Error: Azure CLI is not installed. Please install it first'
        exit 1
    fi
    
    # Check if Static Web Apps extension is installed
    if ! az extension list --query '[?name=='\''staticwebapp'\''].name' -o tsv | grep -q "staticwebapp"; then
        echo "Installing Azure Static Web Apps extension"
        az extension add --name staticwebapp
    fi
    
    APP_URL=$(az staticwebapp show \
        --name {{APP_NAME}} \
        --resource-group {{RESOURCE_GROUP}} \
        --query "defaultHostname" -o tsv)
    
    echo "Frontend URL: https://${APP_URL}"

# Build the project locally
# Usage: just build
build:
    npm run build

# Install dependencies
# Usage: just install
install:
    npm install

# Run development server
# Usage: just dev
dev:
    npm run dev

